/**
 * Scanner de pr√©sences pour le personnel
 * Scanner pour g√©rer les pr√©sences de tout le personnel (enseignants, comptables, surveillants, etc.)
 */

import React, { useState, useEffect, useRef } from 'react';
import { 
    Card, 
    Button, 
    Alert, 
    Container, 
    Row, 
    Col, 
    Table, 
    Badge, 
    Spinner, 
    ButtonGroup, 
    Form,
    Modal,
    ProgressBar,
    Toast,
    ToastContainer
} from 'react-bootstrap';
import { 
    QrCodeScan, 
    CheckCircleFill, 
    XCircleFill, 
    Calendar, 
    Clock, 
    ArrowRightCircle, 
    ArrowLeftCircle,
    PersonBadge,
    Wifi,
    WifiOff,
    CloudArrowUp,
    CloudArrowDown,
    ExclamationTriangle,
    InfoCircle,
    PersonCheck,
    PersonX
} from 'react-bootstrap-icons';
import { useAuth } from '../../hooks/useAuth';
import { secureApiEndpoints } from '../../utils/apiMigration';
import QrScanner from 'qr-scanner';
import Swal from 'sweetalert2';

const TeacherAttendanceScanner = () => {
    const [isScanning, setIsScanning] = useState(false);
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState('');
    const [todayAttendances, setTodayAttendances] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [scannerError, setScannerError] = useState('');
    const [showManualInput, setShowManualInput] = useState(false);
    const [manualQrCode, setManualQrCode] = useState('');
    const [eventType, setEventType] = useState('auto');
    const [entryExitStats, setEntryExitStats] = useState(null);
    const [toastList, setToastList] = useState([]);
    const [staffList, setStaffList] = useState([]);

    const { user } = useAuth();
    
    // Valeurs par d√©faut sans mode offline
    const isOnline = true;
    const isSyncing = false;
    const syncStats = { pendingAttendances: 0 };
    const syncStatus = 'synced';

    const videoRef = useRef(null);
    const qrScannerRef = useRef(null);

    useEffect(() => {
        loadTodayAttendances();
        loadEntryExitStats();
        loadStaffList();
        
        return () => {
            if (qrScannerRef.current) {
                qrScannerRef.current.destroy();
            }
        };
    }, []);


    // Surveiller les changements de synchronisation
    useEffect(() => {
        if (syncStatus === 'syncing') {
            showToast('Synchronisation en cours...', 'info', <CloudArrowUp />);
        } else if (syncStatus === 'success') {
            showToast('Synchronisation termin√©e', 'success', <CheckCircleFill />);
        } else if (syncStatus === 'error') {
            showToast('Erreur de synchronisation', 'danger', <ExclamationTriangle />);
        }
    }, [syncStatus]);

    const loadTodayAttendances = async () => {
        try {
            setIsLoading(true);
            
            if (isOnline) {
                const response = await secureApiEndpoints.staff.getDailyAttendance({
                    supervisor_id: user.id
                });

                if (response.success) {
                    setTodayAttendances(response.data.attendances || []);
                }
            } else {
                // Mode offline: r√©cup√©rer les pr√©sences en attente
                const pendingAttendances = await getPendingTeacherAttendances();
                setTodayAttendances(pendingAttendances);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des pr√©sences:', error);
            showToast('Erreur lors du chargement des pr√©sences', 'danger');
        } finally {
            setIsLoading(false);
        }
    };

    const loadEntryExitStats = async () => {
        try {
            if (!isOnline) return;

            const response = await secureApiEndpoints.staff.getEntryExitStats({
                supervisor_id: user.id
            });

            if (response.success) {
                setEntryExitStats(response.data);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des statistiques:', error);
        }
    };

    const loadStaffList = async () => {
        try {
            if (!isOnline) return;

            const response = await secureApiEndpoints.staff.getStaffWithQR();

            if (response.success) {
                setStaffList(response.data || []);
            }
        } catch (error) {
            console.error('Erreur lors du chargement du personnel:', error);
        }
    };

    const getPendingTeacherAttendances = async () => {
        // Simulation pour mode offline
        const stored = localStorage.getItem('pendingTeacherAttendances');
        return stored ? JSON.parse(stored) : [];
    };

    const saveTeacherAttendanceOffline = async (attendanceData) => {
        const stored = localStorage.getItem('pendingTeacherAttendances');
        const pendingAttendances = stored ? JSON.parse(stored) : [];
        
        const newAttendance = {
            ...attendanceData,
            timestamp: new Date().toISOString(),
            syncStatus: 'pending',
            id: Date.now()
        };
        
        pendingAttendances.push(newAttendance);
        localStorage.setItem('pendingTeacherAttendances', JSON.stringify(pendingAttendances));
        
        return newAttendance;
    };

    const handleScanResult = async (result) => {
        if (!result || result.trim() === '') return;

        console.log('üîç QR Code personnel scann√©:', result);
        setIsScanning(false);
        stopScanner();

        try {
            await processTeacherAttendanceScan(result);
        } catch (error) {
            console.error('Erreur lors du traitement du scan:', error);
            setMessage('Erreur lors du traitement du scan');
            setMessageType('danger');
        }
    };

    const processTeacherAttendanceScan = async (qrCode) => {
        try {
            setIsLoading(true);
            setMessage('');

            const response = await secureApiEndpoints.staff.scanQR({
                staff_qr_code: qrCode,
                supervisor_id: user.id,
                event_type: eventType
            });

            if (response.success) {
                const data = response.data;
                
                setMessage(`‚úÖ ${response.message}`);
                setMessageType('success');
                await loadTodayAttendances();
                await loadEntryExitStats();
                
                // Afficher des informations d√©taill√©es
                if (data.punctuality_info) {
                    const info = data.punctuality_info;
                    let statusMessage = '';
                    
                    if (info.late_minutes > 0) {
                        statusMessage += ` (${info.late_minutes} min de retard)`;
                    }
                    if (info.early_departure_minutes > 0) {
                        statusMessage += ` (${info.early_departure_minutes} min de d√©part anticip√©)`;
                    }
                    if (info.work_hours > 0) {
                        statusMessage += ` (${info.work_hours}h travaill√©es)`;
                    }
                    
                    if (statusMessage) {
                        showToast(`Pr√©sence enregistr√©e${statusMessage}`, 'info');
                    }
                }
                
                showToast('Pr√©sence personnel enregistr√©e', 'success');
            } else {
                setMessage(`‚ùå ${response.message}`);
                setMessageType('danger');
                showToast(response.message, 'danger');
            }

        } catch (error) {
            console.error('Erreur lors du traitement:', error);
            setMessage('‚ùå Erreur lors de l\'enregistrement de la pr√©sence');
            setMessageType('danger');
            showToast('Erreur lors de l\'enregistrement', 'danger');
        } finally {
            setIsLoading(false);
        }
    };

    const startScanner = async () => {
        try {
            setScannerError('');
            setIsScanning(true);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(track => track.stop());
            
            const cameras = await QrScanner.listCameras(true);
            
            if (cameras.length === 0) {
                throw new Error('Aucune cam√©ra trouv√©e sur cet appareil');
            }
            
            if (videoRef.current) {
                qrScannerRef.current = new QrScanner(
                    videoRef.current,
                    (result) => handleScanResult(result.data),
                    {
                        returnDetailedScanResult: true,
                        highlightScanRegion: true,
                        highlightCodeOutline: true,
                    }
                );
                
                await qrScannerRef.current.start();
                console.log('‚úÖ Scanner QR personnel d√©marr√© avec succ√®s');
            }
        } catch (error) {
            console.error('‚ùå Erreur scanner:', error);
            setScannerError(error.message);
            setIsScanning(false);
            showToast('Erreur du scanner: ' + error.message, 'danger');
        }
    };

    const stopScanner = () => {
        if (qrScannerRef.current) {
            qrScannerRef.current.stop();
            setIsScanning(false);
            console.log('‚èπÔ∏è Scanner arr√™t√©');
        }
    };

    const handleManualScan = async () => {
        if (manualQrCode.trim()) {
            await processTeacherAttendanceScan(manualQrCode.trim());
            setManualQrCode('');
            setShowManualInput(false);
        }
    };

    const handleForceSync = async () => {
        try {
            await forceSync();
            showToast('Synchronisation forc√©e termin√©e', 'success');
        } catch (error) {
            showToast('Erreur lors de la synchronisation: ' + error.message, 'danger');
        }
    };

    const showToast = (message, variant = 'info', icon = null) => {
        const id = Date.now();
        const newToast = {
            id,
            message,
            variant,
            icon,
            timestamp: new Date()
        };
        
        setToastList(prev => [...prev, newToast]);
        
        // Auto-suppression apr√®s 5 secondes
        setTimeout(() => {
            setToastList(prev => prev.filter(toast => toast.id !== id));
        }, 5000);
    };

    const getNetworkStatusBadge = () => {
        if (!isOnline) {
            return <Badge bg="warning" className="ms-2">
                <WifiOff size={12} className="me-1" />
                Offline
            </Badge>;
        }
        
        if (isSyncing) {
            return <Badge bg="info" className="ms-2">
                <CloudArrowUp size={12} className="me-1" />
                Sync...
            </Badge>;
        }
        
        return <Badge bg="success" className="ms-2">
            <Wifi size={12} className="me-1" />
            Online
        </Badge>;
    };

    const getAttendanceTypeIcon = (eventType) => {
        return eventType === 'entry' ? (
            <ArrowRightCircle size={12} className="me-1" />
        ) : (
            <ArrowLeftCircle size={12} className="me-1" />
        );
    };

    const getAttendanceTypeBadge = (eventType) => {
        return eventType === 'entry' ? (
            <Badge bg="success" size="sm">
                {getAttendanceTypeIcon(eventType)}
                Entr√©e
            </Badge>
        ) : (
            <Badge bg="warning" size="sm">
                {getAttendanceTypeIcon(eventType)}
                Sortie
            </Badge>
        );
    };

    const getRoleLabel = (role) => {
        const roleLabels = {
            'teacher': 'Enseignant',
            'accountant': 'Comptable',
            'comptable_superieur': 'Comptable Sup√©rieur',
            'general_accountant': 'Comptable G√©n√©ral',
            'surveillant_general': 'Surveillant G√©n√©ral',
            'admin': 'Administrateur',
            'secretaire': 'Secr√©taire'
        };
        return roleLabels[role] || role;
    };

    return (
        <Container fluid className="py-4">
            {/* Header avec statut r√©seau */}
            <Row className="mb-4">
                <Col>
                    <div className="d-flex justify-content-between align-items-center">
                        <div>
                            <h2>
                                <PersonBadge className="me-2" />
                                Scanner Pr√©sences Personnel
                                {getNetworkStatusBadge()}
                            </h2>
                            <p className="text-muted mb-0">
                                Surveillance: {user?.name}
                            </p>
                        </div>
                        
                        <ButtonGroup>
                            <Button 
                                variant="outline-info"
                                onClick={() => setShowOfflineModal(true)}
                            >
                                <InfoCircle className="me-1" />
                                Status ({syncStats.pendingAttendances || 0})
                            </Button>
                        </ButtonGroup>
                    </div>
                </Col>
            </Row>

            {/* Statistiques rapides */}
            {entryExitStats && entryExitStats.stats_by_type && (
                <Row className="mb-4">
                    <Col md={3}>
                        <Card className="text-center">
                            <Card.Body>
                                <PersonCheck size={24} className="text-success mb-2" />
                                <h4>
                                    {Object.values(entryExitStats.stats_by_type).reduce((sum, stats) => sum + (stats.present_count || 0), 0)}
                                </h4>
                                <small className="text-muted">Pr√©sents</small>
                            </Card.Body>
                        </Card>
                    </Col>
                    <Col md={3}>
                        <Card className="text-center">
                            <Card.Body>
                                <ArrowRightCircle size={24} className="text-primary mb-2" />
                                <h4>
                                    {Object.values(entryExitStats.stats_by_type).reduce((sum, stats) => sum + (stats.entries || 0), 0)}
                                </h4>
                                <small className="text-muted">Entr√©es</small>
                            </Card.Body>
                        </Card>
                    </Col>
                    <Col md={3}>
                        <Card className="text-center">
                            <Card.Body>
                                <ArrowLeftCircle size={24} className="text-warning mb-2" />
                                <h4>
                                    {Object.values(entryExitStats.stats_by_type).reduce((sum, stats) => sum + (stats.exits || 0), 0)}
                                </h4>
                                <small className="text-muted">Sorties</small>
                            </Card.Body>
                        </Card>
                    </Col>
                    <Col md={3}>
                        <Card className="text-center">
                            <Card.Body>
                                <Clock size={24} className="text-danger mb-2" />
                                <h4>
                                    {Object.values(entryExitStats.stats_by_type).reduce((sum, stats) => sum + (stats.late_count || 0), 0)}
                                </h4>
                                <small className="text-muted">En retard</small>
                            </Card.Body>
                        </Card>
                    </Col>
                </Row>
            )}

            {/* Alerte mode offline */}
            {!isOnline && (
                <Alert variant="warning" className="mb-4">
                    <WifiOff className="me-2" />
                    <strong>Mode offline activ√©</strong> - Les pr√©sences seront synchronis√©es automatiquement lors du retour en ligne.
                    {syncStats.pendingAttendances > 0 && (
                        <span className="ms-2">
                            ({syncStats.pendingAttendances} pr√©sence(s) en attente)
                        </span>
                    )}
                </Alert>
            )}

            {/* Interface de scan principale */}
            <Row>
                <Col lg={6} className="mb-4">
                    <Card>
                        <Card.Header className="d-flex justify-content-between align-items-center">
                            <div>
                                <QrCodeScan className="me-2" />
                                Scanner QR Code Personnel
                            </div>
                            <ButtonGroup size="sm">
                                <Button 
                                    variant="outline-secondary"
                                    onClick={() => setShowManualInput(!showManualInput)}
                                >
                                    Saisie manuelle
                                </Button>
                            </ButtonGroup>
                        </Card.Header>
                        
                        <Card.Body>
                            {/* Contr√¥les du scanner */}
                            <div className="mb-3">
                                <div className="d-flex gap-2 mb-3">
                                    <Button 
                                        variant={isScanning ? "danger" : "success"}
                                        onClick={isScanning ? stopScanner : startScanner}
                                        disabled={isLoading}
                                    >
                                        {isScanning ? "Arr√™ter" : "D√©marrer"} Scanner
                                    </Button>
                                    
                                    <Form.Select 
                                        value={eventType} 
                                        onChange={(e) => setEventType(e.target.value)}
                                        style={{ width: 'auto' }}
                                    >
                                        <option value="auto">Auto-d√©tection</option>
                                        <option value="entry">Entr√©e forc√©e</option>
                                        <option value="exit">Sortie forc√©e</option>
                                    </Form.Select>
                                </div>

                                {/* Saisie manuelle */}
                                {showManualInput && (
                                    <div className="mb-3">
                                        <div className="d-flex gap-2">
                                            <Form.Control
                                                type="text"
                                                placeholder="Code QR personnel"
                                                value={manualQrCode}
                                                onChange={(e) => setManualQrCode(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && handleManualScan()}
                                            />
                                            <Button 
                                                variant="primary" 
                                                onClick={handleManualScan}
                                                disabled={!manualQrCode.trim() || isLoading}
                                            >
                                                Scanner
                                            </Button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Zone de scan vid√©o */}
                            <div className="text-center">
                                <video 
                                    ref={videoRef}
                                    style={{ 
                                        width: '100%', 
                                        maxWidth: '400px',
                                        height: '300px',
                                        border: '2px solid #dee2e6',
                                        borderRadius: '8px',
                                        display: isScanning ? 'block' : 'none'
                                    }}
                                />
                                
                                {!isScanning && (
                                    <div 
                                        className="d-flex align-items-center justify-content-center text-muted"
                                        style={{ height: '300px', border: '2px dashed #dee2e6', borderRadius: '8px' }}
                                    >
                                        <div className="text-center">
                                            <PersonBadge size={48} className="mb-2" />
                                            <p>Scanner QR Code Personnel</p>
                                            <small className="text-muted">Cliquez sur "D√©marrer Scanner"</small>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Messages et erreurs */}
                            {scannerError && (
                                <Alert variant="danger" className="mt-3">
                                    {scannerError}
                                </Alert>
                            )}
                            
                            {message && (
                                <Alert variant={messageType} className="mt-3">
                                    {message}
                                </Alert>
                            )}

                            {/* Loader */}
                            {isLoading && (
                                <div className="text-center mt-3">
                                    <Spinner animation="border" variant="primary" />
                                    <p className="mt-2 text-muted">Traitement en cours...</p>
                                </div>
                            )}
                        </Card.Body>
                    </Card>
                </Col>

                {/* Liste des pr√©sences du jour */}
                <Col lg={6} className="mb-4">
                    <Card>
                        <Card.Header className="d-flex justify-content-between align-items-center">
                            <div>
                                <Calendar className="me-2" />
                                Pr√©sences Personnel du jour
                            </div>
                            <div>
                                {isSyncing && <Spinner animation="border" size="sm" className="me-2" />}
                                <Button 
                                    variant="outline-primary" 
                                    size="sm"
                                    onClick={loadTodayAttendances}
                                    disabled={isLoading}
                                >
                                    Actualiser
                                </Button>
                                {!isOnline && syncStats.pendingAttendances > 0 && (
                                    <Button 
                                        variant="warning" 
                                        size="sm"
                                        onClick={handleForceSync}
                                        disabled={isSyncing}
                                        className="ms-2"
                                    >
                                        <CloudArrowUp className="me-1" />
                                        Sync ({syncStats.pendingAttendances})
                                    </Button>
                                )}
                            </div>
                        </Card.Header>
                        
                        <Card.Body style={{ maxHeight: '500px', overflowY: 'auto' }}>
                            {todayAttendances.length > 0 ? (
                                <Table responsive size="sm">
                                    <thead>
                                        <tr>
                                            <th>Heure</th>
                                            <th>Personnel</th>
                                            <th>Type</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {todayAttendances.map((attendance, index) => (
                                            <tr key={index}>
                                                <td>
                                                    <small>
                                                        <Clock size={12} className="me-1" />
                                                        {attendance.scanned_at || attendance.timestamp ? 
                                                            new Date(attendance.scanned_at || attendance.timestamp).toLocaleTimeString() : 
                                                            'N/A'
                                                        }
                                                    </small>
                                                </td>
                                                <td>
                                                    <small>
                                                        {attendance.user?.name || attendance.teacher?.full_name || attendance.teacherName || attendance.staffName || 'Inconnu'}
                                                        {attendance.user?.role && (
                                                            <span className="text-muted"> - {getRoleLabel(attendance.user.role)}</span>
                                                        )}
                                                    </small>
                                                </td>
                                                <td>
                                                    {getAttendanceTypeBadge(attendance.event_type || attendance.eventType)}
                                                </td>
                                                <td>
                                                    {attendance.syncStatus === 'pending' ? (
                                                        <Badge bg="secondary" size="sm">En attente</Badge>
                                                    ) : attendance.syncStatus === 'syncing' ? (
                                                        <Badge bg="info" size="sm">Sync...</Badge>
                                                    ) : attendance.syncStatus === 'error' ? (
                                                        <Badge bg="danger" size="sm">Erreur</Badge>
                                                    ) : (
                                                        <Badge bg="success" size="sm">
                                                            <CheckCircleFill size={12} />
                                                        </Badge>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </Table>
                            ) : (
                                <div className="text-center text-muted py-4">
                                    <PersonX size={32} className="mb-2" />
                                    <p>Aucune pr√©sence personnel enregistr√©e aujourd'hui</p>
                                </div>
                            )}
                        </Card.Body>
                    </Card>
                </Col>
            </Row>

            {/* Modal de statut offline */}
            <Modal show={showOfflineModal} onHide={() => setShowOfflineModal(false)}>
                <Modal.Header closeButton>
                    <Modal.Title>
                        <InfoCircle className="me-2" />
                        Statut de Synchronisation
                    </Modal.Title>
                </Modal.Header>
                <Modal.Body>
                    <div className="mb-3">
                        <strong>Statut r√©seau:</strong> 
                        <Badge bg={isOnline ? "success" : "warning"} className="ms-2">
                            {isOnline ? "En ligne" : "Hors ligne"}
                        </Badge>
                    </div>
                    
                    <div className="mb-3">
                        <strong>Pr√©sences en attente:</strong> {syncStats.pendingAttendances || 0}
                    </div>
                    
                    <div className="mb-3">
                        <strong>Personnel charg√©:</strong> {staffList.length}
                    </div>
                    
                    {isSyncing && (
                        <div className="mb-3">
                            <ProgressBar animated now={100} label="Synchronisation en cours..." />
                        </div>
                    )}
                </Modal.Body>
                <Modal.Footer>
                    <Button variant="secondary" onClick={() => setShowOfflineModal(false)}>
                        Fermer
                    </Button>
                    {isOnline && syncStats.pendingAttendances > 0 && (
                        <Button variant="primary" onClick={handleForceSync} disabled={isSyncing}>
                            <CloudArrowUp className="me-1" />
                            Synchroniser
                        </Button>
                    )}
                </Modal.Footer>
            </Modal>

            {/* Toasts de notification */}
            <ToastContainer position="top-end" className="p-3">
                {toastList.map(toast => (
                    <Toast 
                        key={toast.id}
                        bg={toast.variant}
                        show={true}
                        onClose={() => setToastList(prev => prev.filter(t => t.id !== toast.id))}
                        delay={5000}
                        autohide
                    >
                        <Toast.Body className="text-white">
                            {toast.icon && <span className="me-2">{toast.icon}</span>}
                            {toast.message}
                        </Toast.Body>
                    </Toast>
                ))}
            </ToastContainer>
        </Container>
    );
};

export default TeacherAttendanceScanner;